name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Code Quality & Testing
  test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pylint black
      
      - name: üé® Check Code Formatting (Black)
        run: |
          black --check --diff app.py examiner_logic.py pdf_handler.py || true
      
      - name: üîç Lint with Flake8
        run: |
          # Stop build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: üîç Lint with Pylint
        run: |
          pylint app.py examiner_logic.py pdf_handler.py --exit-zero
      
      - name: ‚úÖ Syntax Check
        run: |
          python -m py_compile app.py
          python -m py_compile examiner_logic.py
          python -m py_compile pdf_handler.py
      
      - name: üìä Generate Test Report
        if: always()
        run: |
          echo "## Test Results ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "All code quality checks passed!" >> $GITHUB_STEP_SUMMARY

  # Job 2: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üîí Install Safety
        run: pip install safety
      
      - name: üîç Check Dependencies for Vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check --json || true
      
      - name: üìä Security Report
        if: always()
        run: |
          echo "## Security Scan üîí" >> $GITHUB_STEP_SUMMARY
          echo "Dependency vulnerability scan completed" >> $GITHUB_STEP_SUMMARY

  # Job 3: Deploy to EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: üöÄ Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USERNAME}@${EC2_HOST} << 'ENDSSH'
            set -e
            echo "üîÑ Starting deployment..."
            
            # Run deployment script
            cd ~
            sudo ./deploy.sh
            
            echo "‚úÖ Deployment completed!"
          ENDSSH
      
      - name: üè• Health Check
        run: |
          echo "Waiting for application to start..."
          sleep 10
          
          # Health check with retry
          for i in {1..5}; do
            if curl -f https://examinerai.yousuf-dev.com/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          exit 1
      
      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
      
      - name: üîÑ Rollback on Failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            cd ~
            ./rollback.sh <<< "latest"
          ENDSSH

  # Job 4: Notify
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: üì¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment succeeded!"
          else
            echo "‚ùå Deployment failed!"
          fi